from sqlalchemy.ext.asyncio import AsyncSession
from app.repositories.base import BaseRepository
from app.models import Dataset

from sqlalchemy import text

class DatasetRepository(BaseRepository[Dataset]):
    def __init__(self, session: AsyncSession):
        super().__init__(session, Dataset)
    
    async def create(self, **kwargs) -> Dataset:
        # Create the dataset record
        dataset = await super().create(**kwargs)
        
        # Create a partition for this dataset features
        # Partition name convention: cell_objects_<clean_uuid>
        partition_name = f"cell_objects_{str(dataset.id).replace('-', '_')}"
        ds_id_str = str(dataset.id)
        
        # Safe interpolation because ID is UUID generated by us
        sql = f"""
            CREATE TABLE IF NOT EXISTS "{partition_name}" 
            PARTITION OF cell_objects 
            FOR VALUES IN ('{ds_id_str}')
        """
        await self.session.execute(text(sql))
        await self.session.commit()
        
        return dataset
